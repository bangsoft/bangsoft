# 1ë‹¨ê³„: ë¹Œë”
FROM node:20-alpine AS builder

WORKDIR /app

# ëª¨ë“  ì˜ì¡´ì„± ì„¤ì¹˜ (ë¹Œë“œì— í•„ìš”)
COPY package*.json ./
RUN npm install

# Nest CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ npx ì‚¬ìš©
# ë˜ëŠ” ì•„ë˜ì˜ global ì„¤ì¹˜ ì¤‘ í•˜ë‚˜ ì„ íƒ

# ğŸ‘‰ ì˜µì…˜ 1: npx ì‚¬ìš©í•´ nest build ì‹¤í–‰ (ì¶”ì²œ)
COPY . .
RUN npx nest build

# ğŸ‘‰ ì˜µì…˜ 2: Nest CLI ê¸€ë¡œë²Œ ì„¤ì¹˜
# RUN npm install -g @nestjs/cli
# COPY . .
# RUN nest build

# í”„ë¡œë•ì…˜ìš© ì˜ì¡´ì„±ë§Œ ë‹¤ì‹œ ì„¤ì¹˜
RUN npm prune --production

# 2ë‹¨ê³„: ëŸ°íƒ€ì„ ì´ë¯¸ì§€
FROM node:20-alpine

WORKDIR /app

# ë¹Œë“œëœ ê²°ê³¼ë¬¼, ì˜ì¡´ì„± ë³µì‚¬
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/node_modules ./node_modules

EXPOSE 3000

CMD ["node", "dist/main"]
